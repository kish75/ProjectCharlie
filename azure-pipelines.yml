trigger: none

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      name: 'testpool'
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'

# prepare sonar cloud
    - task: SonarCloudPrepare@4
      inputs:
        SonarQube: 'sonar-connection'
        organization: 'kish75'
        scannerMode: 'cli'
        configMode: 'manual'
        cliProjectKey: 'kish75_ProjectCharlie'
        cliProjectName: 'ProjectCharlie'
        cliSources: '.'


    - task: Npm@1
      inputs:
        command: 'custom'
        customCommand: 'install -D tailwindcss postcss autoprefixer'

    - task: Npm@1
      inputs:
        command: 'custom'
        customCommand: 'run build'

   # - task: SonarCloudAnalyze@4
    - task: SonarCloudPublish@4
      inputs:
        pollingTimeoutSec: '300'

    - task: ArchiveFiles@2
      displayName: ' Zip dist folder'
      inputs:
        rootFolderOrFile: 'dist'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/reactapp.zip'
        replaceExistingArchive: true
              
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'react-build'
       

# DAST

- stage: DAST
  dependsOn: Build
  jobs:
  - job: ZAPScan
    pool:
      name: 'testpool'
    steps:

    - script: |
        start "" "C:\Program Files\OWASP\Zed Attack Proxy\zap.bat" -daemon -port 8090
        timeout /t 20
      displayName: 'Start ZAP in Daemon Mode'

    - script: |
        "C:\Program Files\OWASP\Zed Attack Proxy\zap.bat" -cmd -quickurl http://localhost:3000 -quickout zap-report.html
      displayName: 'Run ZAP Quick Scan'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'zap-report.html'
        ArtifactName: 'DAST-Report'